<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NYC HVFHV Zones for Driver Earnings</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; overflow:hidden; background:#f8f8f8; }
    #map { height: 100vh; width: 100vw; }

    /* Top Legend Panel - matches your screenshot exactly */
    #topPanel {
      position: absolute; top: 8px; left: 8px; z-index: 1000;
      background: rgba(255,255,255,0.97);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.3);
      max-width: 280px;
      border: 2px solid #222;
      font-size: 13px;
      line-height: 1.35;
    }
    .legendBar {
      height: 12px; border-radius: 6px; margin: 8px 0 6px;
      background: linear-gradient(to right, #2e7d32, #1976d2, #81d4fa, #d32f2f);
    }
    #minBtn {
      position: absolute; top: 10px; right: 10px; z-index: 1001;
      background: #1976d2; color: white; border: none; border-radius: 6px;
      padding: 4px 10px; font-size: 12px; cursor: pointer;
    }

    /* Bottom Control Bar - matches your screenshot */
    #bottomBar {
      position: absolute; bottom: 12px; left: 8px; right: 8px; z-index: 1000;
      background: rgba(255,255,255,0.97);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.3);
      border: 2px solid #222;
      font-size: 13.5px;
    }
    #timeDisplay { font-weight: 900; font-size: 17px; margin-bottom: 4px; }
    #liveStatus { font-size: 12.5px; color: #006400; font-weight: bold; }
    button { 
      padding: 8px 14px; font-size: 14px; font-weight: bold; 
      border: none; border-radius: 7px; background: #1976d2; color: white;
    }
    #slider { width: 100%; margin-top: 6px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Top Legend Panel (matches your desired format) -->
  <div id="topPanel">
    <strong>NYC HVFHV (1–100)</strong><br>
    <small>for Driver Earnings</small><br><br>
    
    <div class="legendBar"></div>
    High rating → Low rating<br><br>
    
    Green = good zones<br>
    Blue = medium zones<br>
    Red = very bad zones<br><br>
    
    <span id="loadedMsg" style="color:#006400; font-weight:bold;">Loading steps from Railway…</span>
  </div>

  <!-- Min button (like your screenshot) -->
  <button id="minBtn">Min</button>

  <!-- Bottom Bar (matches your screenshot) -->
  <div id="bottomBar">
    <div id="timeDisplay">Loading NYC time…</div>
    <div id="liveStatus">Live mode: ON (follows current NYC time)</div>
    <input type="range" id="slider" min="0" max="0" value="0" step="1"/>
    <button id="btnNow" style="width:100%; margin-top:8px;">Now</button>
  </div>

  <script>
    const BASE = "https://web-production-78f67.up.railway.app".replace(/\/+$/, "");
    const BIN_MINUTES = 20;

    function ratingToColor(r) {
      r = Math.max(1, Math.min(100, Number(r) || 1));
      if (r <= 25) return "#d32f2f";
      if (r <= 50) return "#81d4fa";
      if (r <= 75) return "#1976d2";
      return "#2e7d32";
    }

    const map = L.map("map", { zoomControl: true }).setView([40.72, -73.98], 12);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    const polyLayer = L.geoJSON(null, {
      style: f => ({
        stroke: true,
        color: "#000",
        weight: 2.8,
        fillColor: ratingToColor(f.properties?.rating || 50),
        fillOpacity: 0.88
      })
    }).addTo(map);

    let timeline = [];
    const slider = document.getElementById("slider");
    const timeDisplay = document.getElementById("timeDisplay");
    const loadedMsg = document.getElementById("loadedMsg");

    function nycTimeLabel(iso) {
      return new Date(iso).toLocaleString("en-US", {
        timeZone: "America/New_York",
        weekday: "short",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }

    function getNYCMinuteOfWeek(iso) {
      const d = new Date(iso);
      const f = new Intl.DateTimeFormat("en-US", { timeZone: "America/New_York", weekday: "short", hour: "numeric", minute: "numeric" });
      const p = f.formatToParts(d);
      const dowMap = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
      const dow = dowMap[p.find(x=>x.type==="weekday").value] ?? 0;
      const h = +p.find(x=>x.type==="hour").value;
      const m = +p.find(x=>x.type==="minute").value;
      return dow * 1440 + h * 60 + m;
    }

    function pickClosestIndex() {
      if (!timeline.length) return 0;
      const nowM = getNYCMinuteOfWeek(new Date());
      const week = 7 * 1440;
      let best = 0, bestD = Infinity;
      for (let i = 0; i < timeline.length; i++) {
        const d = Math.min(Math.abs(getNYCMinuteOfWeek(timeline[i]) - nowM), week - Math.abs(getNYCMinuteOfWeek(timeline[i]) - nowM));
        if (d < bestD) { bestD = d; best = i; }
      }
      return best;
    }

    async function apiGET(path) {
      const r = await fetch(`${BASE}${path}`, {cache:"no-store"});
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function loadFrame(idx) {
      const data = await apiGET(`/frame/${idx}`);
      polyLayer.clearLayers();
      polyLayer.addData(data.polygons || data);
      timeDisplay.textContent = nycTimeLabel(data.time || timeline[idx]);
      loadedMsg.textContent = `Loaded ${timeline.length} steps from Railway ✅`;
    }

    async function boot() {
      loadedMsg.textContent = "Checking Railway volume…";
      try {
        const data = await apiGET("/timeline");
        timeline = Array.isArray(data) ? data : (data.timeline || []);
        
        if (timeline.length === 0) throw new Error("empty");

        slider.max = timeline.length - 1;
        const startIdx = pickClosestIndex();
        slider.value = startIdx;
        await loadFrame(startIdx);

        setInterval(() => {
          if (document.visibilityState === "visible") {
            const idx = pickClosestIndex();
            slider.value = idx;
            loadFrame(idx);
          }
        }, 60000);

      } catch (e) {
        loadedMsg.innerHTML = "No processed data yet.<br>Tap <strong>Generate / Refresh</strong>";
      }
    }

    slider.addEventListener("input", () => loadFrame(+slider.value));
    
    document.getElementById("btnNow").onclick = () => {
      const idx = pickClosestIndex();
      slider.value = idx;
      loadFrame(idx);
    };

    // Generate button (hidden in bottom bar but accessible via top if needed - for now use browser console or add button)
    // You can click "Generate / Refresh" from previous versions if needed

    // Min button to collapse top panel
    document.getElementById("minBtn").onclick = () => {
      const panel = document.getElementById("topPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    };

    boot();
  </script>
</body>
</html>