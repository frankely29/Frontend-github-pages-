<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NYC HVFHV Zones for Driver Earnings</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: white; padding: 12px; border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.3); max-width: 340px;
      border: 2px solid #111;
    }
    button { padding: 10px 14px; font-size: 15px; font-weight: bold; border: none; border-radius: 8px; margin: 5px 0; }
    #btnNow, #btnGenerate { background: #1976d2; color: white; }
    #timeLabel { font-weight: 900; font-size: 18px; margin: 8px 0; }
    #status { font-size: 13px; color: #333; }
    #slider { width: 100%; margin-top: 8px; }
    .legendBar {
      height: 12px; border-radius: 6px; margin: 8px 0;
      background: linear-gradient(to right, #2e7d32, #1976d2, #81d4fa, #d32f2f);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="ui">
    <strong>NYC HVFHV Zones (1â€“100) for Driver Earnings</strong><br><br>
    
    <strong>Colors (Demand-Based Rating):</strong><br>
    ðŸŸ¢ Green = Best (High Demand/Earnings)<br>
    ðŸ”µ Blue = Medium<br>
    ðŸŸ¦ Sky = Normal<br>
    ðŸ”´ Red = Avoid (Low Demand)<br><br>
    
    <div class="legendBar"></div>
    <small>High rating â†’ Low rating</small><br><br>

    <button id="btnNow">Now (NYC)</button>
    <button id="btnGenerate">Generate</button>

    <div id="timeLabel">Loadingâ€¦</div>
    <div id="status">Loading from Railwayâ€¦</div>
    <input type="range" id="slider" min="0" max="0" value="0" step="1"/>
  </div>

  <script>
    // === YOUR RAILWAY URL (confirmed from your repo) ===
    window.RAILWAY_BASE_URL = "https://web-production-78f67.up.railway.app";

    const BASE = window.RAILWAY_BASE_URL.replace(/\/+$/, "");
    const BIN_MINUTES = 20;

    // Strict rating â†’ color (MANDATORY â€“ no changes)
    function ratingToColor(r) {
      r = Math.max(1, Math.min(100, Number(r) || 1));
      if (r <= 25) return "#d32f2f";   // Red = Avoid
      if (r <= 50) return "#81d4fa";   // Sky = Normal
      if (r <= 75) return "#1976d2";   // Blue = Medium
      return "#2e7d32";                // Green = Best
    }

    const map = L.map("map").setView([40.72, -73.98], 12);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    const polyLayer = L.geoJSON(null, {
      style: f => {
        const rating = f.properties?.rating || f.properties?.rating_1_100 || 50;
        return {
          stroke: true,
          color: "#111",
          weight: 1.5,
          fillColor: ratingToColor(rating),
          fillOpacity: 0.75
        };
      }
    }).addTo(map);

    let timeline = [];
    const slider = document.getElementById("slider");
    const timeLabel = document.getElementById("timeLabel");
    const statusEl = document.getElementById("status");

    function setStatus(msg) { statusEl.textContent = msg; }

    function nycTimeLabel(iso) {
      return new Date(iso).toLocaleString("en-US", {
        timeZone: "America/New_York",
        weekday: "short",
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }

    // NYC minute-of-week (Monday=0 â€¦ Sunday=6) with week wrap
    function getNYCMinuteOfWeek(iso) {
      const d = new Date(iso);
      const opts = { timeZone: "America/New_York", weekday: "short", hour: "numeric", minute: "numeric" };
      const parts = new Intl.DateTimeFormat("en-US", opts).formatToParts(d);
      const dowMap = { Mon: 0, Tue: 1, Wed: 2, Thu: 3, Fri: 4, Sat: 5, Sun: 6 };
      const dow = dowMap[parts.find(p => p.type === "weekday").value] ?? 0;
      const hour = parseInt(parts.find(p => p.type === "hour").value);
      const min = parseInt(parts.find(p => p.type === "minute").value);
      return dow * 1440 + hour * 60 + min;
    }

    function pickClosestIndex() {
      if (!timeline.length) return 0;
      const nowM = getNYCMinuteOfWeek(new Date());
      let bestIdx = 0, bestDiff = Infinity;
      const week = 7 * 1440;
      for (let i = 0; i < timeline.length; i++) {
        const tM = getNYCMinuteOfWeek(timeline[i]);
        const diff = Math.min(Math.abs(tM - nowM), week - Math.abs(tM - nowM));
        if (diff < bestDiff) { bestDiff = diff; bestIdx = i; }
      }
      return bestIdx;
    }

    async function apiGET(path) {
      const res = await fetch(`${BASE}${path}`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function loadFrame(idx) {
      const data = await apiGET(`/frame/${idx}`);
      polyLayer.clearLayers();
      const geo = data.polygons || data.geojson || data;
      if (geo) polyLayer.addData(geo);

      const t = data.time || timeline[idx];
      timeLabel.textContent = nycTimeLabel(t);
      setStatus(`Loaded ${timeline.length} steps from Railway âœ…`);
    }

    async function boot() {
      setStatus("Loading timeline from Railwayâ€¦");
      try {
        const data = await apiGET("/timeline");
        timeline = Array.isArray(data) ? data : (data.timeline || []);
        if (!timeline.length) throw new Error("No timeline");

        slider.max = timeline.length - 1;
        const startIdx = pickClosestIndex();
        slider.value = startIdx;
        await loadFrame(startIdx);

        // Live mode â€“ update every 60 seconds
        setInterval(async () => {
          if (document.visibilityState === "visible") {
            const idx = pickClosestIndex();
            slider.value = idx;
            await loadFrame(idx);
          }
        }, 60000);

      } catch (e) {
        console.error(e);
        setStatus("No data yet â€“ click Generate (upload PARQUET files on Railway first)");
        timeLabel.textContent = "Click Generate";
      }
    }

    slider.addEventListener("input", async () => {
      await loadFrame(parseInt(slider.value));
    });

    document.getElementById("btnNow").onclick = async () => {
      const idx = pickClosestIndex();
      slider.value = idx;
      await loadFrame(idx);
    };

    document.getElementById("btnGenerate").onclick = async () => {
      setStatus("Generating on Railwayâ€¦ (1â€“2 min)");
      try {
        await fetch(`${BASE}/generate?bin_minutes=20&good_n=200&bad_n=120&win_good_n=80&win_bad_n=40&min_trips_per_window=10&simplify_meters=25`, { method: "POST" });
        setStatus("Generation started â€“ waiting for Railwayâ€¦");
        // Auto-retry load after 90 seconds
        setTimeout(boot, 90000);
      } catch (e) {
        setStatus("Generate failed â€“ check Railway logs");
      }
    };

    boot();
  </script>
</body>
</html>